<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Sans:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <style>
    /* Motion design tokens (Apple-like feel) */
    :root {
      --ease-spring: cubic-bezier(0.22, 1, 0.36, 1);
      --ease-standard: cubic-bezier(0.2, 0.8, 0.2, 1);
      --ease-decel: cubic-bezier(0.05, 0.7, 0.1, 1);
      --dur-fast: 180ms;
      --dur-med: 280ms;
      --dur-slow: 420ms;
    }

    /* Enhanced Chat Widget Styles */
    .chat-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

  .chat-toggle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ce00c2ff 0%, #5200e7ff 100%);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transition: transform var(--dur-med) var(--ease-spring),
        box-shadow var(--dur-med) var(--ease-spring);
        position: relative;
    }

    .chat-toggle:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }

    .notification-badge {
        position: absolute;
        top: -2px;
        right: -2px;
        background: #ff4757;
        color: white;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 10px;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
        animation: pulse 2s infinite;
    }

  .notification-badge.show {
    display: flex;
  }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .chat-container {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 35rem;
        height: 30rem;
        background: white;
        border-radius: 16px;
        box-shadow: 0 12px 48px rgba(0,0,0,0.15);
        display: none;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid #e1e5e9;
    }

  .chat-container.open {
    display: flex;
    animation: slideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px) scale(0.98); filter: blur(2px); }
    to   { opacity: 1; transform: translateY(0) scale(1);   filter: blur(0); }
  }

    .chat-header {
        background: linear-gradient(135deg, #ce00c2ff 0%, #5200e7ff 100%);
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chat-title {
        font-weight: 600;
        font-size: 16px;
    }

    .chat-status {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 2px;
    }

  .chat-close {
        background: none;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
  border-radius: 4px;
  transition: background-color var(--dur-fast) var(--ease-spring);
    }

    .chat-close:hover {
        background: rgba(255,255,255,0.1);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        background: #f8f9fa;
        max-height: 400px;
    }

    .message {
        margin-bottom: 16px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .message.user {
        flex-direction: row-reverse;
    }

    .message-content {
        max-width: 80%;
        padding: 14px 18px;
        border-radius: 20px;
        font-size: 14px;
        line-height: 1.5;
        word-wrap: break-word;
    }

    .message.bot .message-content {
        background: white;
        border: 1px solid #e1e5e9;
        border-bottom-left-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .message.user .message-content {
        background: linear-gradient(135deg, #ce00c2ff 0%, #5200e7ff 100%);
        color: white;
        border-bottom-right-radius: 8px;
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
    }

    .message.bot .message-avatar {
        background: #e8f4fd;
        color: #1976d2;
    }

    .message.user .message-avatar {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .agent-badge {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        margin-bottom: 8px;
        display: inline-block;
    }

    .notification-agent .agent-badge { background: #fff3e0; color: #f57c00; }
    .ticket-agent .agent-badge { background: #fce4ec; color: #c2185b; }

    .chat-input-container {
        padding: 16px;
        border-top: 1px solid #e1e5e9;
        background: white;
    }

    .chat-input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }

  .chat-input {
        flex: 1;
        border: 1px solid #e1e5e9;
        border-radius: 20px;
        padding: 12px 16px;
        font-size: 14px;
        outline: none;
        resize: none;
        max-height: 80px;
  min-height: 40px;
  transition: border-color var(--dur-fast) var(--ease-spring),
  box-shadow var(--dur-fast) var(--ease-spring),
  transform var(--dur-fast) var(--ease-spring);
    }

    .chat-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

  .send-button {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #ce00c2ff 0%, #5200e7ff 100%);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
  justify-content: center;
  transition: transform var(--dur-fast) var(--ease-spring),
        box-shadow var(--dur-fast) var(--ease-spring);
    }

    .send-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        display: none;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 20px;
        border-bottom-left-radius: 8px;
        max-width: 80%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .typing-indicator.show {
        display: flex;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
    }

  .typing-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
  background: #999;
  animation: typingBounce 1.4s cubic-bezier(0.34, 1.56, 0.64, 1) infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-8px); }
    }

    .quick-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
    }

  .quick-suggestion {
        background: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 16px;
        padding: 6px 12px;
        font-size: 12px;
  cursor: pointer;
  transition: background-color var(--dur-fast) var(--ease-spring),
        border-color var(--dur-fast) var(--ease-spring),
        color var(--dur-fast) var(--ease-spring),
        transform var(--dur-fast) var(--ease-spring);
    }

    .quick-suggestion:hover {
        background: #e0e0e0;
        border-color: #667eea;
        color: #667eea;
    }

    .response-metadata {
        font-size: 11px;
        color: #666;
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
    }

    .summary-box {
        background: #f8f9ff;
        border: 1px solid #e1e8ff;
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
    }

    .insights-list {
        margin: 8px 0;
    }

    .insights-list li {
        margin: 4px 0;
        color: #444;
    }

    .metric-highlight {
        background: #fff9e6;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 600;
        color: #b8860b;
    }

    /* New Table Styles for Column Switching */
    .contacts-table-container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
        position: relative;
    }

    .table-header {
        background: #313131;
        color: white;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 20;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .table-title {
        font-size: 18px;
        font-weight: 600;
    }

    .column-navigation {
        display: flex;
        align-items: center;
        gap: 15px;
    }

  .nav-button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 36px;
        height: 36px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
  transition: transform var(--dur-fast) var(--ease-spring),
        background-color var(--dur-fast) var(--ease-standard);
    }

    .nav-button:hover:not(:disabled) {
        background: rgba(255,255,255,0.3);
        transform: scale(1.05);
    }

    .nav-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }

    .column-indicator {
        font-size: 14px;
        font-weight: 500;
        min-width: 100px;
        text-align: center;
    }

    .contacts-table {
        width: 100%;
        border-collapse: collapse;
        position: relative;
    }

    .contacts-table thead {
        top: 80px; /* Account for table-header height */
        z-index: 15;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .contacts-table thead tr {
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
    }

    .contacts-table th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        font-size: 14px;
        border-right: 1px solid #e9ecef;
    }

    .contacts-table th:last-child {
        border-right: none;
    }

    .contacts-table th.fixed-column {
        background: #f1f3f4;
        position: sticky;
        left: 0;
        z-index: 25; /* Higher than thead to stack properly */
        min-width: 200px;
        box-shadow: 2px 0 4px rgba(0,0,0,0.05);
    }

    .contacts-table td {
        padding: 16px 20px;
        border-bottom: 1px solid #e9ecef;
        border-right: 1px solid #e9ecef;
        font-size: 14px;
        color: #495057;
    }

    .contacts-table td:last-child {
        border-right: none;
    }

    .contacts-table td.fixed-column {
        background: #fafbfc;
        position: sticky;
        left: 0;
        z-index: 19; /* Below thead but above regular content */
        font-weight: 500;
        min-width: 200px;
        box-shadow: 2px 0 4px rgba(0,0,0,0.03);
    }

    .contacts-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        display: inline-block;
    }

    .status-sent {
        background: #d4edda;
        color: #155724;
    }

    .status-pending {
        background: #fff3cd;
        color: #856404;
    }

    .status-answered {
        background: #d1ecf1;
        color: #0c5460;
    }

  .action-button {
        background: linear-gradient(135deg, #ce00c2ff 0%, #5200e7ff 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
  font-weight: 500;
  transition: transform var(--dur-fast) var(--ease-spring),
      box-shadow var(--dur-fast) var(--ease-spring),
      opacity var(--dur-fast) var(--ease-spring);
    }

  /* Subtle page-level appearances */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .quick-stats .quick-stats-item {
  animation: fadeInUp var(--dur-slow) var(--ease-decel) both;
  }
  .quick-stats .quick-stats-item:nth-child(1) { animation-delay: 0ms; }
  .quick-stats .quick-stats-item:nth-child(2) { animation-delay: 60ms; }
  .quick-stats .quick-stats-item:nth-child(3) { animation-delay: 120ms; }
  .quick-stats .quick-stats-item:nth-child(4) { animation-delay: 180ms; }

  .contacts-table tbody tr {
    animation: none;
  transition: background-color var(--dur-fast) var(--ease-standard);
  }

  /* Only-when-updating: prevent whole-row re-animations */
  .contacts-table.is-updating tbody tr { animation: none !important; }

  /* Column switch animation (applies only to dynamic middle column) */
  .dynamic-cell { will-change: transform, opacity; }
  @keyframes colSlideInLeft {
    from { opacity: 0; transform: translateX(-8px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  @keyframes colSlideInRight {
    from { opacity: 0; transform: translateX(8px); }
    to   { opacity: 1; transform: translateX(0); }
  }
  .col-slide-in-left  { animation: colSlideInLeft  var(--dur-fast) var(--ease-standard) both; }
  .col-slide-in-right { animation: colSlideInRight var(--dur-fast) var(--ease-standard) both; }

  /* Press states for natural feel */
  .action-button:active,
  .nav-button:active,
  .send-button:active {
    transform: scale(0.98);
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    * { animation: none !important; transition: none !important; }
  }

    .action-button:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(206, 0, 194, 0.3);
    }

    /* Hide original table */
    .table {
        display: none;
    }

    /* Responsive */
  @media (max-width: 768px) {
    .chat-container {
      position: fixed; /* anchor to viewport instead of chat-widget */
      left: 16px;
      right: 16px;
      bottom: 80px;
      top: auto;
      width: auto;
      max-width: none;
      height: min(70vh, calc(100vh - 160px));
      z-index: 2000; /* above page content */
    }
        
        .chat-toggle {
            width: 56px;
            height: 56px;
            font-size: 22px;
        }

        .contacts-table th,
        .contacts-table td {
            padding: 12px 16px;
            font-size: 13px;
        }

        .column-navigation {
            gap: 10px;
        }

        .column-indicator {
            font-size: 12px;
            min-width: 80px;
        }

        .table-header {
            padding: 16px;
        }

        .contacts-table thead {
            top: 68px; /* Adjust for smaller table-header */
        }
    }

    /* iPhone 16 Pro and similar narrow devices (402px and below) */
    @media (max-width: 402px) {
        .contacts-table-container {
            margin: 20px -10px 0 -10px; /* Extend to screen edges */
            border-radius: 12px;
        }

        .table-header {
            padding: 14px 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .table-title {
            font-size: 16px;
            width: 100%;
            text-align: center;
            margin-bottom: 8px;
        }

        .column-navigation {
            width: 100%;
            justify-content: center;
            gap: 8px;
        }

        .column-indicator {
            font-size: 11px;
            min-width: 70px;
        }

        .nav-button {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }

        .contacts-table th,
        .contacts-table td {
            padding: 10px 8px;
            font-size: 12px;
        }

        .contacts-table th.fixed-column,
        .contacts-table td.fixed-column {
            min-width: 120px; /* Reduce fixed column width */
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .contacts-table thead {
            top: 90px; /* Adjust for wrapped table-header */
        }

        .action-button {
            padding: 6px 10px;
            font-size: 10px;
            border-radius: 6px;
        }

        .status-badge {
            padding: 3px 8px;
            font-size: 10px;
        }

        /* Adjust container padding on very narrow screens */
        .container {
            padding: 0 10px;
        }

    .quick-stats {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 8px;
      scroll-snap-type: x mandatory;
    }

    .quick-stats-item {
      min-width: 120px;
      flex: 0 0 120px;
      scroll-snap-align: start;
    }
    }

    /* Performance indicator */
    .performance-indicator {
        position: absolute;
        top: 8px;
        right: 60px;
        background: rgba(255,255,255,0.9);
        border-radius: 12px;
        padding: 4px 8px;
        font-size: 10px;
        color: #666;
    }

  </style>
</head>
<body class="admin-page">
    <div class="container">
  <header>
    <img src="./avecta-logo.svg" alt="Avecta AI Logo" class="avecta-logo">
  </header>

    <h2>Painel Geral</h2>
    <div class="quick-stats">

        <div class="quick-stats-item quick-stats__total">
          <div class="quick-stats__icon">
            <div class="quick-stats__counter">
              <span>0</span>
            </div>
            <i><img src="./total-icon.svg" alt="" srcset=""></i>
          </div>
          <p class="quick-stats__label"></p>
        </div>

        <div class="quick-stats-item quick-stats__enviados">
          <div class="quick-stats__icon">
            <div class="quick-stats__counter">
              <span>0</span>
            </div>
            <i><img src="./enviado-icon.svg" alt="" srcset=""></i>
          </div>
          <p class="quick-stats__label"></p>
        </div>

        <div class="quick-stats-item quick-stats__respondidos">
          <div class="quick-stats__icon">
            <div class="quick-stats__counter">
              <span>0</span>
            </div>
            <i><img src="./recebido-icon.svg" alt="" srcset=""></i>
          </div>
          <p class="quick-stats__label"></p>
        </div>

        <div class="quick-stats-item quick-stats__pendentes">
          <div class="quick-stats__icon">
            <div class="quick-stats__counter">
              <span>0</span>
            </div>
            <i><img src="./pendente-icon.svg" alt="" srcset=""></i>
          </div>
          <p class="quick-stats__label"></p>
        </div>
    </div>

    <div class="actions-toggle" style="margin: .5rem 0 .5rem .5rem;">
      <a href="#" id="toggleActions" aria-expanded="false" aria-controls="actionsBar">Mostrar ações</a>
    </div>
    <div class="ds-inline-controls" id="actionsBar" style="margin-bottom:8px;">
      <input id="filterNeighborhood" class="ds-input" placeholder="Filtrar por bairro">
      <select id="filterAnswered" class="ds-select">
        <option value="">Todos</option>
        <option value="true">Respondidos</option>
        <option value="false">Não respondidos</option>
      </select>
      <button id="btnFilter" class="ds-btn">Aplicar Filtro</button>
      <button id="btnExport" class="ds-btn ds-btn--secondary">Exportar CSV</button>
    </div>

    <!-- New Column-Switching Table -->
    <div class="contacts-table-container">
      <div class="table-header">
        <div class="table-title">Contatos</div>
        <div class="column-navigation">
          <button id="reset-demo-inline" style="display:none; background:#fff;color:#5200e7;border:1px solid #e1e5e9;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;margin-right:8px">Reset Demo Data</button>
          <button id="restore-seed-inline" style="display:none; background:#fff;color:#0f7b0f;border:1px solid #cfe8cf;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;margin-right:8px">Restore Demo Data</button>
          <button class="nav-button" id="prevColumn" onclick="switchColumn(-1)">‹</button>
          <div class="column-indicator" id="columnIndicator">Nome • Idade</div>
          <button class="nav-button" id="nextColumn" onclick="switchColumn(1)">›</button>
        </div>
      </div>
      
      <div class="contacts-table-scroll">
        <table class="contacts-table" id="newContactsTable">
          <thead>
            <tr>
              <th class="fixed-column">Nome</th>
              <th id="dynamicColumnHeader">Idade</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Original table (hidden but preserved for compatibility) -->
    <table class="table" id="contactsTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Idade</th>
          <th>Bairro</th>
          <th>WhatsApp</th>
          <th>Enviado</th>
          <th>Status</th>
          <th>Clicou</th>
          <th>Respondeu</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Slide-up Panel for Citizen Details -->
  <div class="slide-panel-overlay" id="slidePanelOverlay" onclick="closeCitizenPanel()">
  </div>
  
  <div class="slide-panel" id="slidePanel">
    <div class="slide-panel-handle" onclick="closeCitizenPanel()"></div>
    
    <div class="slide-panel-header">
      <h2 class="slide-panel-title" id="citizenName">Detalhes do Cidadão</h2>
      <button class="slide-panel-close" onclick="closeCitizenPanel()">&times;</button>
    </div>
    
    <div class="slide-panel-content" id="citizenDetails">
      <!-- Content will be populated by JavaScript -->
    </div>
  </div>

  <!-- Enhanced AI Chat Widget -->
  <div class="chat-widget">
    <div class="performance-indicator" id="performanceIndicator">Ready</div>
    <button class="chat-toggle" id="chatToggle">
      <div class="notification-badge" id="notificationBadge">!</div>
      <img src="./ia-icon.svg" alt="icone de IA" srcset="" id="toggleIcon">
    </button>
    
    <div class="chat-container" id="chatContainer">
      <div class="chat-header">
        <div>
          <div class="chat-title">Assistente IA</div>
          <div class="chat-status" id="chatStatus">Ativo</div>
        </div>
        <button class="chat-close" id="chatClose">&times;</button>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="message bot">
          <div class="message-avatar"><img src="./ia-icon.svg" alt="IA Icon" srcset=""></div>
          <div class="message-content">
            <div class="agent-badge">System</div>
              <p>Sou o Assistente de IA da AvectaAI! Tenho acesso aos dados reais de pesquisa e posso ajudar com:</p>
              <ul>
                <li>📊 <strong>Agente de Conhecimento</strong> - Análise de Satisfação, Análise de Problemas, Análise de Bairros</li>
                <li>📱 <strong>Agente de Notificação</strong> - Notificações de Atualizações, Notificações Generalistas, Notificações Seguimentadas</li>
                <li>🎫 <strong>Agente de Sistema</strong> - Status do Sistema, Dados e Informações, Exportações</li>
              </ul>

            <div class="quick-suggestions">
              <button class="quick-suggestion" onclick="sendQuickMessage('Show satisfaction analysis')">Análise de Satisfação</button>
              <button class="quick-suggestion" onclick="sendQuickMessage('Find dissatisfied residents')">Análise de Insatisfação</button>
              <button class="quick-suggestion" onclick="sendQuickMessage('Which neighborhoods need follow-up')">Análise de Bairros</button>
              <button class="quick-suggestion" onclick="sendQuickMessage('System status')">Status do Sistema</button>
              <button class="quick-suggestion" onclick="sendQuickMessage('Listar moradores interessados em participar')">Participação: interessados</button>
              <button class="quick-suggestion" onclick="sendQuickMessage('Mostrar moradores que não querem participar')">Participação: não interessados</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="chat-input-container">
        <div class="typing-indicator" id="typingIndicator">
          <div class="message-avatar">🤖</div>
          <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
          </div>
          <span style="font-size: 12px; color: #666; margin-left: 8px;">AI analyzing data...</span>
        </div>
        
        <div class="chat-input-wrapper">
          <textarea 
            class="chat-input" 
            id="chatInput" 
            placeholder="Try: 'analyze satisfaction by neighborhood' or 'send follow-up to dissatisfied residents'"
            rows="1"
          ></textarea>
          <button class="send-button" id="sendButton">
            <img src="./send-icon.svg" alt="" srcset="">
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="./toast.js"></script>
  <script>
    // Initialize shared ToastManager for admin
    const toastManager = new ToastManager();
  // Column switching functionality
  let currentColumnIndex = 0;
  let lastDirection = 0; // -1 prev, 1 next (for animation direction)
  let contactsData = [];
  
const columns = [
    { key: 'age', label: 'Idade', render: (value) => value || '—' },
    { key: 'neighborhood', label: 'Bairro', render: (value) => value || '—' },
    { key: 'whatsapp', label: 'WhatsApp', render: (value) => {
        if (!value) return '—';
        // Truncate WhatsApp for display but keep full value in title
        const display = value.length > 15 ? value.substring(0, 12) + '...' : value;
        return `<span title="${value}">${display}</span>`;
    }},
    { key: 'whatsappSentAt', label: 'Enviado', render: (value) => value ? '<span class="status-badge status-sent">✓</span>' : '<span class="status-badge status-pending">—</span>' },
    { key: 'whatsappStatus', label: 'Status', render: (value) => value ? `<span class="status-badge status-${value}">${value.substring(0, 8)}</span>` : '—' },
    { key: 'clickedAt', label: 'Clicou', render: (value) => value ? new Date(value).toLocaleDateString() : '—' },
    { key: 'survey', label: 'Respondeu', render: (value) => value ? '<span class="status-badge status-answered">✓</span>' : '<span class="status-badge status-pending">✗</span>' }
];

  function switchColumn(direction) {
    const newIndex = currentColumnIndex + direction;
    
    // Check bounds and prevent navigation beyond limits
    if (newIndex < 0 || newIndex >= columns.length) {
      return; // Don't change index if we're at the boundaries
    }
    
  currentColumnIndex = newIndex;
  lastDirection = direction;
  // prevent whole table flashing during update
  const table = document.getElementById('newContactsTable');
  if (table) table.classList.add('is-updating');
  updateTableView();
  }

function updateTableView() {
    const currentColumn = columns[currentColumnIndex];
    const header = document.getElementById('dynamicColumnHeader');
    const indicator = document.getElementById('columnIndicator');
    const tbody = document.querySelector('#newContactsTable tbody');
  const table = document.getElementById('newContactsTable');
    const prevButton = document.getElementById('prevColumn');
    const nextButton = document.getElementById('nextColumn');
    
    // Update header and indicator
    header.textContent = currentColumn.label;
    indicator.textContent = `Nome • ${currentColumn.label}`;
    
    // Update navigation buttons
    prevButton.disabled = currentColumnIndex === 0;
    nextButton.disabled = currentColumnIndex === columns.length - 1;
    
    // Re-render table body with current column
    tbody.innerHTML = '';
    contactsData.forEach(contact => {
        const tr = document.createElement('tr');
        tr.onclick = () => openCitizenPanel(contact);
        
        // Create cells with proper truncation
        const nameCell = document.createElement('td');
        nameCell.className = 'fixed-column';
        nameCell.textContent = contact.name;
        nameCell.title = contact.name; // Show full name on hover
        
        const dynamicCell = document.createElement('td');
        dynamicCell.className = 'dynamic-cell';
        dynamicCell.innerHTML = currentColumn.render(contact[currentColumn.key]);
        // Directional slide-in animation only after a user-initiated switch
        if (lastDirection !== 0) {
          const dirClass = lastDirection > 0 ? 'col-slide-in-right' : 'col-slide-in-left';
          dynamicCell.classList.add(dirClass);
          dynamicCell.addEventListener('animationend', () => {
            dynamicCell.classList.remove('col-slide-in-left', 'col-slide-in-right');
          }, { once: true });
        }
        
        // Add title for truncated content
        if (typeof contact[currentColumn.key] === 'string') {
            dynamicCell.title = contact[currentColumn.key];
        }
        
  const actionCell = document.createElement('td');
  actionCell.innerHTML = `<button class="action-button secondary" onclick="event.stopPropagation(); openCitizenPanelById(${contact.id})">Detalhes</button>`;
        
        tr.appendChild(nameCell);
        tr.appendChild(dynamicCell);
        tr.appendChild(actionCell);
    tbody.appendChild(tr);
    });

    // Remove is-updating after dynamic cell animation completes to avoid flashes
    if (table) {
      const dynamicCells = tbody.querySelectorAll('.dynamic-cell');
      if (lastDirection !== 0 && dynamicCells.length) {
        let done = 0;
        const total = dynamicCells.length;
        const cleanup = () => {
          done += 1;
          if (done >= total) table.classList.remove('is-updating');
        };
        dynamicCells.forEach(dc => dc.addEventListener('animationend', cleanup, { once: true }));
        // Fallback safety timeout in case animationend doesn't fire
        setTimeout(() => table.classList.remove('is-updating'), 400);
      } else {
        // No directional animation (e.g., initial render)
        requestAnimationFrame(() => table.classList.remove('is-updating'));
      }
    }
}

  // Slide Panel Functionality
  function openCitizenPanel(citizen) {
    const overlay = document.getElementById('slidePanelOverlay');
    const panel = document.getElementById('slidePanel');
    const nameElement = document.getElementById('citizenName');
    const detailsElement = document.getElementById('citizenDetails');
    
    // Set citizen name
    nameElement.textContent = citizen.name || 'Cidadão';
    
    // Generate detailed view
    detailsElement.innerHTML = generateCitizenDetails(citizen);
    
    // Show panel with animation
    overlay.classList.add('active');
    panel.classList.add('active');
    
    // Prevent body scroll when panel is open
    document.body.style.overflow = 'hidden';
  }

  function openCitizenPanelById(id) {
    const contact = contactsData.find(c => c.id === id);
    if (!contact) { alert('Contato não encontrado.'); return; }
    openCitizenPanel(contact);
  }

  function closeCitizenPanel() {
    const overlay = document.getElementById('slidePanelOverlay');
    const panel = document.getElementById('slidePanel');
    
    overlay.classList.remove('active');
    panel.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
  }

  function generateCitizenDetails(citizen) {
    const formatDate = (dateStr) => {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleString('pt-BR');
    };

    const formatPhone = (phone) => {
      if (!phone) return '—';
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 11) {
        return `(${cleaned.slice(0,2)}) ${cleaned.slice(2,7)}-${cleaned.slice(7)}`;
      }
      return phone;
    };

    const generateStars = (rating) => {
      if (!rating) return '<span class="empty">Não avaliado</span>';
      const stars = [];
      for (let i = 1; i <= 5; i++) {
        stars.push(`<span class="star ${i <= rating ? '' : 'empty'}">★</span>`);
      }
      return stars.join('');
    };

    // Map real survey satisfaction to a 1–5 score for the star UI
    const mapSatisfactionToRating = (s) => {
      if (!s) return null;
      const map = {
        'Muito satisfeito': 5,
        'Satisfeito': 4,
        'Neutro': 3,
        'Insatisfeito': 2,
        'Muito insatisfeito': 1
      };
      return map[s] ?? null;
    };

    const satisfactionRating = citizen.survey ? mapSatisfactionToRating(citizen.survey.satisfaction) : null;

    return `
      <div class="citizen-detail-grid">
        <!-- Personal Information -->
        <div class="detail-card">
          <h3>Informações Pessoais</h3>
          <div class="detail-field">
            <span class="detail-label">Nome Completo</span>
            <span class="detail-value">${citizen.name || '—'}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Idade</span>
            <span class="detail-value">${citizen.age || '—'} anos</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Bairro</span>
            <span class="detail-value">${citizen.neighborhood || '—'}</span>
          </div>
        </div>

        <!-- Contact Information -->
        <div class="detail-card">
          <h3>Contato</h3>
          <div class="detail-field">
            <span class="detail-label">WhatsApp</span>
            <span class="detail-value">${formatPhone(citizen.whatsapp)}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Status de Envio</span>
            <span class="detail-value">
              ${citizen.whatsappSentAt ? 
                `<span class="status-badge status-sent">Enviado em ${formatDate(citizen.whatsappSentAt)}</span>` : 
                '<span class="status-badge status-pending">Não enviado</span>'
              }
            </span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Status WhatsApp</span>
            <span class="detail-value">
              ${citizen.whatsappStatus ? 
                `<span class="status-badge status-${citizen.whatsappStatus}">${citizen.whatsappStatus}</span>` : 
                '—'
              }
            </span>
          </div>
        </div>

        <!-- Interaction History -->
        <div class="detail-card">
          <h3>Histórico de Interação</h3>
          <div class="detail-field">
            <span class="detail-label">Link Clicado</span>
            <span class="detail-value">
              ${citizen.clickedAt ? 
                `✅ ${formatDate(citizen.clickedAt)}` : 
                '<span class="status-badge status-pending">Não clicou</span>'
              }
            </span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Pesquisa Respondida</span>
            <span class="detail-value">
              ${citizen.survey ? 
                `✅ ${formatDate(citizen.survey.answeredAt)}` : 
                '<span class="status-badge status-pending">Não respondeu</span>'
              }
            </span>
          </div>
        </div>

        <!-- System Data -->
        <div class="detail-card">
          <h3>Dados do Sistema</h3>
          <div class="detail-field">
            <span class="detail-label">ID do Contato</span>
            <span class="detail-value">#${citizen.id}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Criado em</span>
            <span class="detail-value">${formatDate(citizen.createdAt)}</span>
          </div>
          <div class="detail-field">
            <span class="detail-label">Última Atualização</span>
            <span class="detail-value">${formatDate(citizen.updatedAt)}</span>
          </div>
        </div>
      </div>

      ${citizen.survey ? `
        <div class="survey-response">
          <h4>
            Resposta da Pesquisa
          </h4>

          <!-- Removed star rating; show satisfaction text only -->
          <div class="detail-field">
            <span class="detail-label">Satisfação</span>
            <span class="detail-value">${citizen.survey.satisfaction || '—'}</span>
          </div>

          <div class="detail-field">
            <span class="detail-label">Problema principal</span>
            <span class="detail-value">${citizen.survey.issue || '—'}</span>
          </div>

          ${citizen.survey.otherIssue ? `
            <div class="detail-field">
              <span class="detail-label">Detalhe do problema</span>
              <span class="detail-value">${citizen.survey.otherIssue}</span>
            </div>
          ` : ''}

          <div class="detail-field">
            <span class="detail-label">Interessado em participar</span>
            <span class="detail-value">${citizen.survey.participate || '—'}</span>
          </div>

          <div class="detail-field">
            <span class="detail-label">Respondido em</span>
            <span class="detail-value">${formatDate(citizen.survey.answeredAt)}</span>
          </div>
        </div>
      ` : `
        <div class="empty-state">
          <div class="empty-state-icon">📝</div>
          <h3>Nenhuma resposta de pesquisa</h3>
          <p>Este cidadão ainda não respondeu à pesquisa de satisfação.</p>
        </div>
      `}

      <div class="action-buttons">
        <button class="panel-action-button secondary" onclick="(async () => { 
          const loading = toastManager ? toastManager.info('Abrindo WhatsApp...', { title: 'Processando', progress: true, duration: 8000 }) : null;
          try {
            openWhatsAppWithTemplateById(${citizen.id});
            await fetch('/api/contacts/${citizen.id}/mark-sent', { method: 'POST' });
            if (toastManager && loading) toastManager.remove(loading);
            if (toastManager) toastManager.success('Marcado como enviado.', { title: 'Concluído' });
            loadContacts();
          } catch (e) {
            if (toastManager && loading) toastManager.remove(loading);
            if (toastManager) toastManager.error('Não foi possível marcar como enviado.', { title: 'Erro' });
          }
        })()">Abrir no WhatsApp</button>
        <button class="panel-action-button" onclick="copySurveyLinkById(${citizen.id})">Copiar Link</button>
      </div>
    `;
  }

  function exportCitizenData(citizenId) {
    const citizen = contactsData.find(c => c.id === citizenId);
    if (!citizen) return;
    
    const data = {
      ...citizen,
      exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `citizen-${citizen.id}-${citizen.name.replace(/\s+/g, '-')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Existing table functionality (preserved and enhanced)
  async function loadContacts() {
    const q = new URLSearchParams();
    const nb = document.getElementById("filterNeighborhood").value.trim();
    const answered = document.getElementById("filterAnswered").value;
    if (nb) q.set("neighborhood", nb);
    if (answered) q.set("answered", answered);

    try {
      const res = await fetch("/api/contacts?legacy=true&" + q.toString());
      const data = await res.json();
      
      // Store data for column switching
      contactsData = data;
      
      // Update original table (hidden)
      const tbody = document.querySelector("#contactsTable tbody");
      tbody.innerHTML = "";

      data.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${c.age || ""}</td>
          <td>${c.neighborhood}</td>
          <td>${c.whatsapp}</td>
          <td>${c.whatsappSentAt ? '<span class="sent">✅</span>' : '<span class="pending">—</span>'}</td>
          <td>${c.whatsappStatus ? `<span class="${c.whatsappStatus}">${c.whatsappStatus}</span>` : '—'}</td>
          <td>${c.clickedAt ? new Date(c.clickedAt).toLocaleString() : '—'}</td>
          <td>${c.survey ? ('✅ ' + new Date(c.survey.answeredAt).toLocaleString()) : '<span class="pending">⌀</span>'}</td>
          <td>
            <button onclick="openCitizenPanelById(${c.id})">� Detalhes</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Update new table view
      updateTableView();
      
      // Update quick stats
      updateQuickStats(data);
    } catch (error) {
      console.error('Failed to load contacts:', error);
    }
  }

  function updateQuickStats(data) {
    const total = data.length;
    const answered = data.filter(d => d.survey).length;
    const sent = data.filter(d => d.whatsappSentAt).length;
    const pending = data.filter(d => d.survey === null).length;

    const totalCounter = document.querySelector(".quick-stats__total .quick-stats__counter span");
    const sentCounter = document.querySelector(".quick-stats__enviados .quick-stats__counter span");
    const answeredCounter = document.querySelector(".quick-stats__respondidos .quick-stats__counter span");
    const pendingCounter = document.querySelector(".quick-stats__pendentes .quick-stats__counter span");

    totalCounter.textContent = total;
    sentCounter.textContent = sent;
    answeredCounter.textContent = answered;
    pendingCounter.textContent = pending;

    const totalLabel = document.querySelector(".quick-stats__total .quick-stats__label");
    const sentLabel = document.querySelector(".quick-stats__enviados .quick-stats__label");
    const answeredLabel = document.querySelector(".quick-stats__respondidos .quick-stats__label");
    const pendingLabel = document.querySelector(".quick-stats__pendentes .quick-stats__label");

    totalLabel.textContent = "Total";
    sentLabel.textContent = "Enviadas";
    answeredLabel.textContent = "Respondidas";
    pendingLabel.textContent = "Pendentes";
  }

  async function sendWhatsApp(id) {
    const contact = contactsData.find(c => c.id === id);
    if (!contact) { alert('Contato não encontrado.'); return; }
    openWhatsAppWithTemplate(contact);
    try {
      await fetch(`/api/contacts/${id}/mark-sent`, { method: 'POST' });
      loadContacts();
    } catch (e) {
      console.warn('Falha ao marcar como enviado manualmente:', e);
    }
  }

  // Open WhatsApp with a prefilled template message using contact id
  function openWhatsAppWithTemplateById(id) {
    const contact = contactsData.find(c => c.id === id);
    if (!contact || !contact.whatsapp) {
      alert('Contato sem WhatsApp válido.');
      return;
    }
    openWhatsAppWithTemplate(contact);
  }

  // Build wa.me link with a message template
  function openWhatsAppWithTemplate(contact) {
    const phone = String(contact.whatsapp || '').replace(/\D/g, '');
    const name = contact.name || 'cidadão';
    const neighborhood = contact.neighborhood || 'seu bairro';
  const base = window.APP_BASE_URL || window.location.origin;

    // Basic outreach template; customize as needed
  const message = `Olá, ${name}! Agradecemos a sua participação no Bingo do Bem.\nEstamos realizando uma pesquisa rápida sobre as necessidades do bairro ${neighborhood}.\nPedimos para que responda a pesquisa, leva só 1 minuto!\nAtenciosamente, Luana e Marion.`;
    const url = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  }

  // Copy survey link to clipboard (like index.html)
  function copySurveyLinkById(id) {
    const contact = contactsData.find(c => c.id === id);
    if (!contact) {
      if (typeof toastManager !== 'undefined') {
        toastManager.error('Contato não encontrado.', { title: 'Erro' });
      } else {
        alert('Contato não encontrado.');
      }
      return;
    }
    const base = window.APP_BASE_URL || window.location.origin;
    const surveyLink = `${base}/survey.html?id=${contact.id}`;
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(surveyLink)
        .then(() => {
          if (typeof toastManager !== 'undefined') {
            toastManager.success('Link copiado. Agora cole no WhatsApp.', { title: 'Copiado' });
          } else {
            alert('Link copiado! Agora cole no WhatsApp.');
          }
        })
        .catch(() => {
          if (typeof toastManager !== 'undefined') {
            toastManager.error('Não foi possível copiar automaticamente. Copie manualmente.', { title: 'Erro' });
          } else {
            alert('Não foi possível copiar automaticamente. Copie manualmente: ' + surveyLink);
          }
        });
    } else {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = surveyLink;
      document.body.appendChild(ta);
      ta.select();
      try { 
        document.execCommand('copy'); 
        if (typeof toastManager !== 'undefined') {
          toastManager.success('Link copiado. Agora cole no WhatsApp.', { title: 'Copiado' });
        } else {
          alert('Link copiado! Agora cole no WhatsApp.');
        }
      }
      catch { 
        if (typeof toastManager !== 'undefined') {
          toastManager.error('Não foi possível copiar automaticamente. Copie manualmente.', { title: 'Erro' });
        } else {
          alert('Não foi possível copiar automaticamente. Copie manualmente: ' + surveyLink);
        }
      }
      document.body.removeChild(ta);
    }
  }

  document.getElementById("btnFilter").addEventListener("click", loadContacts);
  document.getElementById("btnExport").addEventListener("click", () => {
    window.location.href = "/api/export";
  });

  // Toggle actions bar visibility
  const toggleActionsLink = document.getElementById('toggleActions');
  const actionsBar = document.getElementById('actionsBar');
  // initialize collapsed
  actionsBar.classList.remove('open');
  toggleActionsLink.addEventListener('click', (e) => {
    e.preventDefault();
    const willOpen = !actionsBar.classList.contains('open');
    actionsBar.classList.toggle('open', willOpen);
    toggleActionsLink.textContent = willOpen ? 'Ocultar ações' : 'Mostrar ações';
    toggleActionsLink.setAttribute('aria-expanded', String(willOpen));
  });

  // Close panel on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeCitizenPanel();
    }
  });

  // Enhanced AI Chat Widget
  class EnhancedChatWidget {
    constructor() {
      this.isOpen = false;
      this.isProcessing = false;
      this.messageHistory = [];
      this.initializeElements();
      this.attachEventListeners();
      this.loadSystemHealth();
    }

    initializeElements() {
      this.chatToggle = document.getElementById('chatToggle');
      this.chatContainer = document.getElementById('chatContainer');
      this.chatClose = document.getElementById('chatClose');
      this.chatMessages = document.getElementById('chatMessages');
      this.chatInput = document.getElementById('chatInput');
      this.sendButton = document.getElementById('sendButton');
      this.typingIndicator = document.getElementById('typingIndicator');
      this.chatStatus = document.getElementById('chatStatus');
      this.notificationBadge = document.getElementById('notificationBadge');
      this.performanceIndicator = document.getElementById('performanceIndicator');
    }

    attachEventListeners() {
      this.chatToggle.addEventListener('click', () => this.toggleChat());
      this.chatClose.addEventListener('click', () => this.closeChat());
      this.sendButton.addEventListener('click', () => this.sendMessage());
      
      this.chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage();
        }
      });

      this.chatInput.addEventListener('input', () => this.autoResize());

      // Close chat when clicking outside
      document.addEventListener('click', (e) => {
        if (this.isOpen && !this.chatContainer.contains(e.target) && !this.chatToggle.contains(e.target)) {
          this.closeChat();
        }
      });
    }

    toggleChat() {
      if (this.isOpen) {
        this.closeChat();
      } else {
        this.openChat();
      }
    }

    openChat() {
      this.isOpen = true;
      this.chatContainer.classList.add('open');
      this.chatInput.focus();
      this.hideNotification();
      this.scrollToBottom();
    }

    closeChat() {
      this.isOpen = false;
      this.chatContainer.classList.remove('open');
    }

    showNotification() {
      this.notificationBadge.classList.add('show');
    }

    hideNotification() {
      this.notificationBadge.classList.remove('show');
    }

    autoResize() {
      this.chatInput.style.height = 'auto';
      this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 80) + 'px';
    }

    async sendMessage() {
      const message = this.chatInput.value.trim();
      if (!message || this.isProcessing) return;

      this.addMessage(message, 'user');
      this.chatInput.value = '';
      this.autoResize();
      
      await this.processMessage(message);
    }

    addMessage(content, sender, metadata = null) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}`;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = sender === 'user' ? '👤' : '🤖';

      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      if (metadata && metadata.agent) {
        const badge = document.createElement('div');
        badge.className = `agent-badge ${metadata.agent.toLowerCase().replace(' ', '-')}`;
        badge.textContent = metadata.agent;
        messageContent.appendChild(badge);
      }

      const textContent = document.createElement('div');
      textContent.innerHTML = this.formatMessage(content);
      messageContent.appendChild(textContent);

      if (metadata) {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'response-metadata';
        metaDiv.innerHTML = this.formatMetadata(metadata);
        messageContent.appendChild(metaDiv);
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(messageContent);

      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();

      return messageDiv;
    }

    formatMessage(content) {
      // Handle natural language responses properly
      if (typeof content === 'string') {
        return content.replace(/\n/g, '<br>');
      }
      
      // If it's still an object (fallback), format it better
      if (typeof content === 'object') {
        // Try to extract natural language from common response patterns
        let html = '';
        const analysis = content.analysis || content;

        if (analysis.summary) {
          html += `<div class="summary-box">${analysis.summary.replace(/\n/g, '<br>')}</div>`;
        }

        // Show resident list if present and non-empty
        if (Array.isArray(analysis.residents) && analysis.residents.length > 0) {
          html += `<div style="margin-top:12px;"><strong>Lista de residentes:</strong><ul style="margin:8px 0 0 16px;">`;
          analysis.residents.forEach((resident, idx) => {
            html += `<li>
              <strong>${resident.name}</strong> (${resident.neighborhood || '—'})<br>
                Satisfação: <span class="metric-highlight">${resident.satisfaction || resident.priority || '—'}</span>
                ${(resident.issue || resident.mainIssue) ? `<br>Problema: ${resident.issue || resident.mainIssue}` : ''}
                ${(resident.participate !== undefined ? `<br>Participação: ${resident.participate}` : (resident.participateInterest !== undefined ? `<br>Participação: ${resident.participateInterest}` : ''))}
                ${resident.whatsapp ? `<br>WhatsApp: <a href="https://wa.me/${resident.whatsapp.replace(/\D/g, '')}" target="_blank">${resident.whatsapp}</a>` : ''}
            </li>`;
          });
          html += `</ul></div>`;
        }

        // Show insights and recommendations if present
        if (Array.isArray(analysis.insights) && analysis.insights.length > 0) {
          html += `<div style="margin-top:10px;"><strong>Insights:</strong><ul class="insights-list">`;
          analysis.insights.forEach(i => html += `<li>${i}</li>`);
          html += `</ul></div>`;
        }
        if (Array.isArray(analysis.recommendations) && analysis.recommendations.length > 0) {
          html += `<div style="margin-top:10px;"><strong>Recomendações:</strong><ul class="insights-list">`;
          analysis.recommendations.forEach(r => html += `<li>${r}</li>`);
          html += `</ul></div>`;
        }

        // Fallback for other object types
        if (!html) {
          html = this.formatFallbackResponse(content);
        }

        return html;
      }
      
      return String(content);
    }

    formatFallbackResponse(response) {
      let html = '';
      
      // Format as natural text instead of technical data
      if (response.query) {
        html += `I processed your query: "${response.query}"<br><br>`;
      }
      
      if (response.intent) {
        html += `The ${response.intent} agent handled this request. `;
      }
      
      if (response.success) {
        html += 'The operation completed successfully.';
      }
      
      return html;
    }

    formatMetadata(metadata) {
      let parts = [];
      
      if (metadata.intent) {
        parts.push(`Intent: ${metadata.intent}`);
      }
      
      if (metadata.confidence) {
        parts.push(`Confidence: ${(metadata.confidence * 100).toFixed(0)}%`);
      }
      
      if (metadata.timestamp) {
        const time = new Date(metadata.timestamp).toLocaleTimeString();
        parts.push(`Time: ${time}`);
      }

      return parts.join(' • ');
    }

    showTyping() {
      this.typingIndicator.classList.add('show');
      this.scrollToBottom();
    }

    hideTyping() {
      this.typingIndicator.classList.remove('show');
    }

    async processMessage(message) {
      this.isProcessing = true;
      this.sendButton.disabled = true;
      this.showTyping();
      
      const startTime = Date.now();
      
      try {
        this.updateStatus('Processing query...');
        this.updatePerformance('Processing...');
        
        // Use streamlined UI endpoint
        const response = await fetch('/api/admin/agent-ui', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ query: message })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const result = await response.json();
        const processingTime = Date.now() - startTime;
        
        this.hideTyping();
        
        if (result.success) {
          // Prefer rich structured rendering using analysis fields when present
          const residentsForSummary = Array.isArray(result.residents) ? result.residents : [];
          let summaryText = (result.report && result.report.text) ? result.report.text : (result.response || result.message || 'Query processed successfully');
          if (residentsForSummary.length) {
            const list = residentsForSummary.map((r, idx) => `${idx + 1}. ${r.name} (${r.neighborhood || '—'})${r.satisfaction ? ` • ${r.satisfaction}` : ''}`).join('\n');
            summaryText += `\n\nRESIDENTES (${residentsForSummary.length}):\n${list}`;
          }
          const analysisPayload = {
            analysis: {
              summary: summaryText,
              residents: residentsForSummary,
              insights: Array.isArray(result.insights) ? result.insights : [],
              recommendations: Array.isArray(result.recommendations) ? result.recommendations : [],
              report: result.report || null
            }
          };

          // Persist the generated analysis payload so report.html can render the exact same data
          const rid = `r_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
          try {
            const payload = { query: message, result };
            localStorage.setItem(`reportPayload:${rid}`, JSON.stringify(payload));
          } catch (e) {
            console.warn('Failed to store report payload:', e);
          }

          // Append a convenience link to open full report page with reference id
          const q = encodeURIComponent(message);
          const base = window.APP_BASE_URL || window.location.origin;
          const linkHtml = `<div style="margin-top:10px"><a href="${base}/report.html?rid=${encodeURIComponent(rid)}&q=${q}" target="_blank" style="text-decoration:none;color:#5200e7;font-weight:600">Abrir relatório completo ↗</a></div>`;
          analysisPayload.analysis.summary = (analysisPayload.analysis.summary || '') + `\n\n` + linkHtml;

          this.addMessage(analysisPayload, 'bot', {
            agent: result.intent ? `${result.intent.charAt(0).toUpperCase() + result.intent.slice(1)} Agent` : 'AI Assistant',
            intent: result.intent,
            timestamp: result.timestamp,
            confidence: result.confidence
          });
          
          this.updateStatus(`${result.intent ? result.intent.charAt(0).toUpperCase() + result.intent.slice(1) : 'AI'} Agent Ready`);
          this.updatePerformance(`${processingTime}ms`);
        } else {
          this.addMessage(result.response || `Error: ${result.error || 'Unknown error occurred'}`, 'bot', {
            agent: 'System',
            timestamp: new Date().toISOString()
          });
          
          this.updateStatus('Error - Please try again');
          this.updatePerformance('Error');
        }

        // Refresh table data after processing
        loadContacts();

      } catch (error) {
        console.error('Chat error:', error);
        this.hideTyping();
        this.addMessage(`Connection error: ${error.message}. Please check if the server is running.`, 'bot', {
          agent: 'System',
          timestamp: new Date().toISOString()
        });
        this.updateStatus('Connection Error');
        this.updatePerformance('Failed');
      } finally {
        this.isProcessing = false;
        this.sendButton.disabled = false;
      }
    }

    updateStatus(status) {
      this.chatStatus.textContent = status;
    }

    updatePerformance(performance) {
      this.performanceIndicator.textContent = performance;
    }

    scrollToBottom() {
      setTimeout(() => {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }, 100);
    }

    async loadSystemHealth() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        
        if (data.database && data.database.contacts > 0) {
          this.updatePerformance(`${data.database.contacts} contacts`);
        }
        
        // Show notification if there are system issues
        if (data.status !== 'healthy') {
          this.showNotification();
        }
      } catch (error) {
        console.error('Failed to load system health:', error);
        this.updatePerformance('Offline');
      }
    }
  }

  function sendQuickMessage(message) {
    const chatWidget = window.chatWidget;
    if (chatWidget) {
      chatWidget.chatInput.value = message;
      if (!chatWidget.isOpen) {
        chatWidget.openChat();
      }
      chatWidget.sendMessage();
    }
  }

  // Initialize everything when page loads
  document.addEventListener('DOMContentLoaded', () => {
    loadContacts();
    window.chatWidget = new EnhancedChatWidget();
    // Fetch runtime config (BASE_URL) once, but safely ignore failures
    fetch('/api/config')
      .then(r => r.ok ? r.json() : null)
      .then(cfg => { 
        if (cfg && cfg.baseUrl) window.APP_BASE_URL = cfg.baseUrl; 
        // Inject tiny reset button if demo reset is enabled
        if (cfg && cfg.demoResetEnabled) {
          // Show inline header button too (fallback)
          const inlineBtn = document.getElementById('reset-demo-inline');
          if (inlineBtn) {
            inlineBtn.style.display = 'inline-block';
            inlineBtn.addEventListener('click', () => {
              const floating = document.getElementById('reset-demo-btn');
              if (floating) floating.click();
            });
          }
          // Show restore seed button
          const restoreBtn = document.getElementById('restore-seed-inline');
          if (restoreBtn) {
            restoreBtn.style.display = 'inline-block';
            restoreBtn.addEventListener('click', async () => {
              const loadingToast = toastManager.info('Restaurando dados de demonstração...', { title: 'Processando', progress: true, duration: 10000 });
              try {
                const res = await fetch('/api/admin/restore-seed', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include' });
                const body = await res.json().catch(() => ({}));
                if (!res.ok) throw new Error(body.error || 'Restore failed');
                toastManager.remove(loadingToast);
                toastManager.success(body.message || 'Dados restaurados com sucesso.', { title: 'Concluído' });
                loadContacts();
              } catch (e) {
                console.error('Restore error:', e);
                toastManager.remove(loadingToast);
                toastManager.error(e.message || 'Falha ao restaurar os dados.', { title: 'Erro' });
              }
            });
          }
          const btn = document.createElement('button');
          btn.id = 'reset-demo-btn';
          btn.textContent = 'Reset Demo Data';
          btn.style.position = 'fixed';
          btn.style.bottom = '20px';
          btn.style.left = '20px';
          btn.style.zIndex = '1001';
          btn.style.padding = '8px 12px';
          btn.style.borderRadius = '8px';
          btn.style.border = '1px solid #e1e5e9';
          btn.style.background = '#fff';
          btn.style.color = '#5200e7';
          btn.style.fontWeight = '600';
          btn.style.boxShadow = '0 4px 10px rgba(0,0,0,0.08)';
          btn.style.cursor = 'pointer';
          btn.title = 'Erase demo contacts (admin only)';
          btn.addEventListener('click', async () => {
            btn.disabled = true;
            btn.textContent = 'Resetting...';
            const loadingToast = toastManager.info('Limpando dados de demonstração...', {
              title: 'Processando',
              progress: true,
              duration: 10000
            });
            try {
              const res = await fetch('/api/admin/reset-data', { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include' });
              const body = await res.json().catch(() => ({}));
              if (!res.ok) throw new Error(body.error || 'Reset failed');
            } catch (e) {
              console.error('Reset error:', e);
              btn.disabled = false;
              btn.textContent = 'Reset Demo Data';
              toastManager.remove(loadingToast);
              toastManager.error(e.message || 'Falha ao apagar os dados.', {
                title: 'Erro ao Resetar'
              });
              return;
            }
            toastManager.remove(loadingToast);
            toastManager.success('Dados de demonstração apagados com sucesso.', {
              title: 'Concluído'
            });
            // Remove button after one successful reset
            btn.remove();
            // Refresh data table
            loadContacts();
          });
          document.body.appendChild(btn);
        }
      })
      .catch(() => {});
    
    // Show a notification after 5 seconds to encourage interaction
    setTimeout(() => {
      if (!window.chatWidget.isOpen) {
        window.chatWidget.showNotification();
      }
    }, 5000);
  });
</script>
</body>
</html>